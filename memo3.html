<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>å…±åŒç·¨é›†ä»˜ç®‹ã‚¢ãƒ—ãƒª (Firebaseç‰ˆ)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
  /* --- ã“ã“ã‹ã‚‰CSS --- */
body {
  font-family: 'Arial', sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f4f4f4;
  display: flex;
  flex-direction: column;
  height: 100vh; /* ç”»é¢å…¨ä½“ã®é«˜ã•ã‚’ä½¿ã† */
  overflow: hidden; /* FABãƒœã‚¿ãƒ³å›ºå®šã®ãŸã‚ã€bodyã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯é˜²ã */
}
header {
  background-color: #039BE5; /* Firebaseã‚«ãƒ©ãƒ¼ã£ã½ã */
  color: white;
  padding: 15px 20px;
  text-align: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  flex-shrink: 0; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã¯ç¸®ã¾ãªã„ */
}
/* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ã¯å‰Šé™¤ */
#notes-container {
  flex-grow: 1; /* æ®‹ã‚Šã®é«˜ã•ã‚’ã™ã¹ã¦ä½¿ç”¨ */
  position: relative; /* ä»˜ç®‹ã®absoluteé…ç½®ã®åŸºæº– */
  overflow: auto; /* â˜… ã‚³ãƒ³ãƒ†ãƒŠå†…ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ã™ã‚‹ */
  padding: 10px;
  margin: 10px; /* ä¸Šä¸‹å·¦å³ã®ãƒãƒ¼ã‚¸ãƒ³ */
  background-color: #e9e9e9;
  border: 1px dashed #ccc;
  border-radius: 8px;
}

/* â–¼â–¼â–¼ ã“ã“ã‹ã‚‰ä»˜ç®‹ã®ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´ â–¼â–¼â–¼ */
.note {
  position: absolute;
  /* â˜… æ¨ªé•·ã«å¤‰æ›´ */
  width: 180px;
  min-height: 120px;
  /* â˜… ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°èª¿æ•´ (ä¸‹éƒ¨ã‚¹ãƒšãƒ¼ã‚¹ç¢ºä¿) */
  padding: 15px 15px 45px 15px;
  /* â˜… å°‘ã—ã ã‘è§’ã‚’ä¸¸ã‚ã‚‹ */
  border-radius: 4px;
  /* â˜… ãƒªã‚¢ãƒ«ãªå½± */
  box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.2),
              0 0 1px rgba(0, 0, 0, 0.1);
  cursor: grab;
  display: flex;
  flex-direction: column;
  font-size: 10px;
  /* â˜… å¢ƒç•Œç·šã¯ç›®ç«‹ãŸã›ãªã„ */
  border: 1px solid transparent;
  /* â˜… å½±ã‚„å¤‰å½¢ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.3s ease;
  /* â˜… ã‚ãšã‹ã«å‚¾ã‘ã‚‹ */
  transform: rotate(-1.2deg);
  /* â˜… ã‚ãã‚Œè¡¨ç¾ã®ãŸã‚ */
  overflow: hidden;
}

.note:hover {
    /* â˜… ãƒ›ãƒãƒ¼æ™‚ã®å½±ã¨æ‹¡å¤§ */
    box-shadow: 5px 5px 12px rgba(0, 0, 0, 0.25),
                0 0 2px rgba(0, 0, 0, 0.1);
    transform: rotate(-1.2deg) scale(1.02);
}

.note:active {
  cursor: grabbing;
  z-index: 1000 !important;
  /* â˜… ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®å½±ã¨å›è»¢ãƒªã‚»ãƒƒãƒˆ */
  box-shadow: 8px 8px 18px rgba(0, 0, 0, 0.3);
  transform: scale(1.05) rotate(0deg);
}

/* â˜… å·¦ä¸‹ã®è§’ãŒå°‘ã—ã‚ãã‚ŒãŸã‚ˆã†ãªè¡¨ç¾ */


.note-content {
  flex-grow: 1;
  white-space: pre-wrap;
  word-wrap: break-word;
  padding: 8px 5px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°å°‘ã—èª¿æ•´ */
  margin-bottom: 5px;
  /* â˜… ä»˜ç®‹æœ¬ä½“ã®è‰²ã‚’æ´»ã‹ã™ */
  background-color: transparent;
  /* â˜… æ ç·šãªã— */
  border: none;
  outline: none;
  /* â˜… ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢æœ€å°é«˜ã•èª¿æ•´ */
  min-height: 70px;
  /* â˜… æ‰‹æ›¸ãé¢¨ãƒ•ã‚©ãƒ³ãƒˆå€™è£œ */
  font-family: 'Comic Sans MS', 'Segoe Print', 'Bradley Hand', cursive, sans-serif;
  /* â˜… è¡Œé–“èª¿æ•´ */
  line-height: 1.5;
}

.note-content:focus {
  /* â˜… ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã¯æ§ãˆã‚ã« */
   background-color: rgba(255,255,255,0.3);
   box-shadow: inset 0 0 2px rgba(0,0,0,0.1);
}

.note-actions {
  /* â˜… ä»˜ç®‹ã®ä¸‹éƒ¨å…¨ä½“ã«åºƒã’ã€å·¦å³ã«è¦ç´ ã‚’é…ç½® */
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  padding: 5px 10px; /* å†…å´ã®ä½™ç™½ */
  display: flex;
  justify-content: space-between; /* å·¦å³ã«æŒ¯ã‚Šåˆ†ã‘ */
  align-items: flex-end; /* ä¸‹æƒãˆ */
  box-sizing: border-box; /* paddingã‚’å«ã‚ã¦å¹…100% */
}

.note-action-left,
.note-action-right {
  display: flex;
  align-items: center;
}
.note-action-left .color-button-container {
    display: flex;
    flex-direction: column; /* ãƒœã‚¿ãƒ³ã¨IDã‚’ç¸¦ã« */
    align-items: center; /* ä¸­å¤®æƒãˆ */
}

/* æ±ç”¨ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« (åŸºæœ¬ãƒªã‚»ãƒƒãƒˆ) */
.note-actions button {
  background: none;
  border: none;
  cursor: pointer;
  padding: 0;
  margin: 0;
  display: flex; /* ã‚¢ã‚¤ã‚³ãƒ³ã‚„ãƒ†ã‚­ã‚¹ãƒˆã®ä¸­å¤®æƒãˆç”¨ */
  justify-content: center;
  align-items: center;
}
.note-actions button:hover {
  opacity: 0.8; /* ãƒ›ãƒãƒ¼æ™‚ã«å°‘ã—é€é */
}

/* ã‚¢ã‚¤ã‚³ãƒ³é¢¨ãƒœã‚¿ãƒ³ (è‰²å¤‰æ›´ãƒœã‚¿ãƒ³) */
.icon-button.color-button {
  width: 24px;
  height: 24px;
  background-color: white;
  border: 1px solid #BDBDBD; /* ã‚°ãƒ¬ãƒ¼ã®æ ç·š */
  border-radius: 4px; /* å°‘ã—è§’ä¸¸ */
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}
/* (ã‚ªãƒ—ã‚·ãƒ§ãƒ³) ã‚¢ã‚¤ã‚³ãƒ³ã‚’å…¥ã‚Œã‚‹å ´åˆ:
.icon-button.color-button::before {
    content: 'ğŸ¨';
    font-size: 16px;
} */

/* ä»˜ç®‹IDã®ã‚¹ã‚¿ã‚¤ãƒ« */
.note-id {
  font-size: 10px; /* å°ã•ã */
  color: #757575; /* ã‚°ãƒ¬ãƒ¼ */
  margin-top: 2px; /* ãƒœã‚¿ãƒ³ã¨ã®é–“éš” */
  max-width: 60px; /* æœ€å¤§å¹…ã‚’æŒ‡å®š */
  white-space: nowrap; /* æŠ˜ã‚Šè¿”ã•ãªã„ */
  overflow: hidden; /* ã¯ã¿å‡ºã—ãŸéƒ¨åˆ†ã‚’éš ã™ */
  text-overflow: ellipsis; /* çœç•¥è¨˜å·(...) */
  display: block; /* max-widthã‚’åŠ¹ã‹ã›ã‚‹ãŸã‚ */
  text-align: center;
}

/* ãƒ†ã‚­ã‚¹ãƒˆãƒœã‚¿ãƒ³ (å‰Šé™¤ãƒœã‚¿ãƒ³) */
.text-button.delete-button {
  background-color: #FFEBEE; /* ç”»åƒã«è¿‘ã„è–„ã„ãƒ”ãƒ³ã‚¯ */
  color: #E53935; /* ç”»åƒã«è¿‘ã„èµ¤ */
  border: 1px solid #FFCDD2; /* ã‚„ã‚„æ¿ƒã„ãƒ”ãƒ³ã‚¯ã®æ ç·š */
  border-radius: 4px;
  padding: 4px 10px;
  font-size: 12px; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºèª¿æ•´ */
  font-weight: normal; /* å¤ªå­—è§£é™¤ */
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  transition: background-color 0.2s ease; /* ãƒ›ãƒãƒ¼åŠ¹æœ */
}

.text-button.delete-button:hover {
  background-color: #FFCDD2; /* ãƒ›ãƒãƒ¼ã§å°‘ã—æ¿ƒã */
  color: #D32F2F;
  opacity: 1; /* ãƒ›ãƒãƒ¼æ™‚ã®é€éã¯è§£é™¤ */
}
/* â–²â–²â–² ä»˜ç®‹ã®ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´ã“ã“ã¾ã§ â–²â–²â–² */


/* --- ä»¥ä¸‹ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯å¤‰æ›´ãªã— --- */

#loading-spinner {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  border: 5px solid #f3f3f3; /* ã‚¹ãƒ”ãƒŠãƒ¼ã®èƒŒæ™¯è‰² */
  border-top: 5px solid #3498db; /* ã‚¹ãƒ”ãƒŠãƒ¼ã®è‰² */
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite; /* å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  display: none; /* æœ€åˆã¯éè¡¨ç¤º */
  z-index: 9999; /* æœ€å‰é¢ã«è¡¨ç¤º */
}
@keyframes spin {
  0% { transform: translate(-50%, -50%) rotate(0deg); }
  100% { transform: translate(-50%, -50%) rotate(360deg); }
}
.status-message {
  /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ç”»é¢ä¸Šéƒ¨ã«å›ºå®šè¡¨ç¤ºã™ã‚‹ä¾‹ */
  position: fixed;
  top: 70px; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä¸‹ã‚ãŸã‚Š */
  left: 50%;
  transform: translateX(-50%);
  background-color: rgba(0, 0, 0, 0.7);
  color: white;
  padding: 8px 15px;
  border-radius: 5px;
  font-size: 0.9em;
  z-index: 1001;
  opacity: 0; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
  transition: opacity 0.5s ease-out;
}
.status-message.show {
    opacity: 1;
}
.error {
  background-color: rgba(211, 47, 47, 0.9); /* ã‚¨ãƒ©ãƒ¼æ™‚ã¯èµ¤èƒŒæ™¯ */
}
.success {
  background-color: rgba(56, 142, 60, 0.9); /* æˆåŠŸæ™‚ã¯ç·‘èƒŒæ™¯ */
}

/* ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼é–¢é€£ (å¤‰æ›´ãªã—) */
.color-option { display: inline-block; width: 20px; height: 20px; margin-right: 5px; border: 1px solid #ccc; border-radius: 3px; cursor: pointer; vertical-align: middle; }
.color-option.selected { border: 2px solid #000; }
.color-palette { position: absolute; bottom: 35px; /* å°‘ã—ä¸Šã« */ right: 5px; background: white; padding: 5px; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 1001; display: flex; gap: 3px; }

/* å³ä¸‹ã®è¿½åŠ ãƒœã‚¿ãƒ³ (FAB: Floating Action Button) */
#add-note-fab {
  position: fixed; /* ç”»é¢ã«å›ºå®š */
  bottom: 30px;    /* ä¸‹ã‹ã‚‰30px */
  right: 30px;     /* å³ã‹ã‚‰30px */
  width: 60px;     /* å¹… */
  height: 60px;    /* é«˜ã• */
  background-color: #2979FF; /* ãƒ‡ã‚¶ã‚¤ãƒ³ç”»åƒã®é’è‰² */
  color: white;    /* æ–‡å­—è‰² ç™½ */
  border: none;
  border-radius: 50%; /* å††å½¢ã«ã™ã‚‹ */
  font-size: 36px;  /* '+' ã®ã‚µã‚¤ã‚º */
  line-height: 58px; /* '+' ã‚’å‚ç›´ä¸­å¤®ã«å¾®èª¿æ•´ */
  text-align: center;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); /* å½± */
  cursor: pointer;
  transition: background-color 0.3s ease, transform 0.2s ease; /* ãƒ›ãƒãƒ¼åŠ¹æœç”¨ */
  z-index: 100; /* ä»–ã®è¦ç´ ã‚ˆã‚Šæ‰‹å‰ã« */
}
#add-note-fab:hover {
  background-color: #1C5EFF; /* ãƒ›ãƒãƒ¼æ™‚ã®è‰² */
  transform: scale(1.05); /* ãƒ›ãƒãƒ¼æ™‚ã«å°‘ã—å¤§ãã */
}
#add-note-fab:active {
    transform: scale(0.95); /* ã‚¯ãƒªãƒƒã‚¯æ™‚ã«å°‘ã—å°ã•ã */
}
/* --- ã“ã“ã¾ã§CSS --- */
  </style>
</head>
<body>

  <!-- controls div ã¯å‰Šé™¤ -->

  <div id="notes-container">
    <!-- ä»˜ç®‹ã¯ã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
    <p style="text-align:center; color:#777; margin-top: 20px;">èª­ã¿è¾¼ã¿ä¸­...</p>
  </div>

  <!-- å³ä¸‹ã®è¿½åŠ ãƒœã‚¿ãƒ³ -->
  <button id="add-note-fab" onclick="addNote()" title="æ–°ã—ã„ä»˜ç®‹ã‚’è¿½åŠ ">+</button>

  <div id="loading-spinner"></div>
  <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç”¨ã®è¦ç´  -->
  <div id="status-message" class="status-message"></div>

  <!-- Firebase SDK ã®èª­ã¿è¾¼ã¿ (v8äº’æ›å½¢å¼) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // â–¼â–¼â–¼â–¼â–¼ Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®š (ã“ã“ã‚’ã‚ãªãŸã®è¨­å®šã«ç½®ãæ›ãˆã¦ãã ã•ã„ï¼) â–¼â–¼â–¼â–¼â–¼
   const firebaseConfig = {
    apiKey: "AIzaSyBlCVsnHnVMA0XG2d-s_MjBGL2bJFVnZ9Y",
    authDomain: "project-8460199666924328110.firebaseapp.com",
    databaseURL: "https://project-8460199666924328110-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "project-8460199666924328110",
    storageBucket: "project-8460199666924328110.firebasestorage.app",
    messagingSenderId: "1021309415683",
    appId: "1:1021309415683:web:aab78eaf8a6bcb6aa1b936",
    measurementId: "G-2VRDM6RHMR"
  };
    // â–²â–²â–²â–²â–² Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®š â–²â–²â–²â–²â–²

    // --- ã“ã“ã‹ã‚‰JavaScript ---

    // FirebaseåˆæœŸåŒ–
    try {
      firebase.initializeApp(firebaseConfig);
    } catch (e) {
      console.error("Firebase initialization error:", e);
      alert("Firebaseã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    }

    const database = firebase.database();
    const notesRef = database.ref('notes'); // Realtime Databaseã®'notes'ãƒ‘ã‚¹ã‚’å‚ç…§

    let notesOnBoard = {}; // { id: {element, data} } ãƒ­ãƒ¼ã‚«ãƒ«ã®ä»˜ç®‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    let draggedNote = null; // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ä»˜ç®‹è¦ç´ 
    let offsetX, offsetY; // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚ã®ãƒã‚¦ã‚¹ã‚ªãƒ•ã‚»ãƒƒãƒˆ
    let initialLoadComplete = false; // åˆå›èª­ã¿è¾¼ã¿å®Œäº†ãƒ•ãƒ©ã‚°
    let statusTimeout; // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç”¨ã‚¿ã‚¤ãƒãƒ¼

    // åˆ©ç”¨å¯èƒ½ãªè‰²
    const noteColors = {
      "#fffacd": "ãƒ¬ãƒ¢ãƒ³",
      "#add8e6": "æ°´è‰²",
      "#90ee90": "é»„ç·‘",
      "#ffb6c1": "ãƒ”ãƒ³ã‚¯",
      "#ffa07a": "ã‚µãƒ¼ãƒ¢ãƒ³",
      "#e6e6fa": "ãƒ©ãƒ™ãƒ³ãƒ€ãƒ¼"
    };

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®å‡¦ç†
    window.onload = function() {
      // Firebaseã®ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã‚’ç›£è¦–é–‹å§‹
      startListening();

      // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ç”¨ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚³ãƒ³ãƒ†ãƒŠã«è¨­å®š
      const notesContainer = document.getElementById('notes-container');
      notesContainer.addEventListener('mousemove', onDrag);
      notesContainer.addEventListener('mouseup', onDragEnd);
      notesContainer.addEventListener('mouseleave', onDragEnd); // ã‚³ãƒ³ãƒ†ãƒŠå¤–ã«å‡ºã¦ã‚‚ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
    };

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤º
    function showLoading(show) {
      document.getElementById('loading-spinner').style.display = show ? 'block' : 'none';
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤ºï¼ˆç”»é¢ä¸Šéƒ¨ï¼‰
    function showStatus(message, type = 'success') {
      const statusEl = document.getElementById('status-message');
      statusEl.textContent = message;
      // æ—¢å­˜ã®ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰æ–°ã—ã„ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
      statusEl.className = 'status-message'; // ãƒªã‚»ãƒƒãƒˆ
      // é…å»¶ã•ã›ã¦ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§CSSãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ãŒåŠ¹ã
      setTimeout(() => {
          statusEl.classList.add('show');
          statusEl.classList.add(type); // success or error
      }, 10); // ã‚ãšã‹ãªé…å»¶

      // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚Œã°ã‚¯ãƒªã‚¢
      if (statusTimeout) clearTimeout(statusTimeout);

      // 3ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆã™ã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®š
      statusTimeout = setTimeout(() => {
         statusEl.classList.remove('show');
         // ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ãŒçµ‚ã‚ã‚‹ã®ã‚’å¾…ã£ã¦ã‹ã‚‰ã‚¯ãƒ©ã‚¹ã‚’å®Œå…¨ã«å‰Šé™¤ï¼ˆä»»æ„ï¼‰
         setTimeout(() => {
            if (!statusEl.classList.contains('show')) {
                statusEl.classList.remove(type);
            }
         }, 500); // CSSã®transitionæ™‚é–“ã¨åˆã‚ã›ã‚‹
        }, 3000);
    }


    // Firebase Realtime Databaseã®å¤‰æ›´ç›£è¦–ã‚’é–‹å§‹
    function startListening() {
      const container = document.getElementById('notes-container');
      showLoading(true);

      // 'value'ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼: 'notes'ãƒ‘ã‚¹ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ãŒå¤‰æ›´ã•ã‚Œã‚‹ãŸã³ã«å‘¼ã³å‡ºã•ã‚Œã‚‹
      notesRef.on('value', (snapshot) => {
        showLoading(false);
        const notesData = snapshot.val(); // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—
        const initialMsg = container.querySelector('p'); // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ 
        if(initialMsg) initialMsg.remove(); // èª­ã¿è¾¼ã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤

        const currentlyDisplayed = new Set(Object.keys(notesOnBoard)); // ç¾åœ¨è¡¨ç¤ºä¸­ã®ID
        const receivedIds = new Set(notesData ? Object.keys(notesData) : []); // DBã‹ã‚‰å–å¾—ã—ãŸID

        if (notesData) {
          // å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰ã‚’å phá»¥cå‡¦ç†
          Object.entries(notesData).forEach(([id, noteData]) => {
            if (typeof noteData !== 'object' || noteData === null || !('content' in noteData)) {
                console.warn("Invalid note data structure found for ID:", id, noteData);
                // notesRef.child(id).remove().catch(err => console.error("Error removing invalid data:", err));
                return; // ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿ã¯ã‚¹ã‚­ãƒƒãƒ—
            }

            if (notesOnBoard[id]) { // æ—¢å­˜ã®ä»˜ç®‹ã‚’æ›´æ–°
                const noteDiv = notesOnBoard[id].element;
                const contentDiv = noteDiv.querySelector('.note-content');
                const localData = notesOnBoard[id].data;

                // å†…å®¹ã®æ›´æ–° (ç·¨é›†ä¸­ã§ãªã‘ã‚Œã°)
                if (document.activeElement !== contentDiv && localData.content !== noteData.content) {
                    contentDiv.textContent = noteData.content;
                }
                // è‰²ã®æ›´æ–°
                if (localData.color !== noteData.color) {
                    noteDiv.style.backgroundColor = noteData.color;
                }
                // ä½ç½®ã®æ›´æ–° (ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã§ãªã‘ã‚Œã°)
                 if ((!draggedNote || draggedNote.dataset.id !== id) && (localData.x !== noteData.x || localData.y !== noteData.y)) {
                    noteDiv.style.left = (noteData.x || 10) + 'px';
                    noteDiv.style.top = (noteData.y || 10) + 'px';
                 }
                // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
                notesOnBoard[id].data = { id, ...noteData };
                currentlyDisplayed.delete(id); // å‡¦ç†æ¸ˆã¿ã¨ã—ã¦Setã‹ã‚‰å‰Šé™¤

            } else { // æ–°ã—ã„ä»˜ç®‹ã‚’ä½œæˆ
                createNoteElement({ id, ...noteData }, container); // ä»˜ç®‹è¦ç´ ã‚’ä½œæˆ
            }
          });
        }

         // DBã«ãªãã¦ãƒ­ãƒ¼ã‚«ãƒ«ã«å­˜åœ¨ã™ã‚‹ï¼ˆå‰Šé™¤ã•ã‚ŒãŸï¼‰ä»˜ç®‹ã‚’DOMã‹ã‚‰å‰Šé™¤
        currentlyDisplayed.forEach(idToRemove => {
            if(notesOnBoard[idToRemove]) {
                notesOnBoard[idToRemove].element.remove();
                delete notesOnBoard[idToRemove];
            }
        });


        // ä»˜ç®‹ãŒä¸€ã¤ã‚‚ãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        if (Object.keys(notesOnBoard).length === 0 && !container.querySelector('.note')) {
           const noNotesMsg = document.createElement('p');
           noNotesMsg.textContent = 'ä»˜ç®‹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œ+ã€ãƒœã‚¿ãƒ³ã‹ã‚‰è¿½åŠ ã—ã¾ã—ã‚‡ã†ï¼';
           noNotesMsg.style.textAlign = 'center';
           noNotesMsg.style.color = '#777';
           noNotesMsg.style.marginTop = '20px';
           container.appendChild(noNotesMsg);
        } else {
           // ã‚‚ã—ã€Œä»˜ç®‹ãªã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°å‰Šé™¤
            const existingMsg = container.querySelector('p');
            if (existingMsg && existingMsg.textContent.includes('ä»˜ç®‹ã¯ã‚ã‚Šã¾')) {
                existingMsg.remove();
            }
        }
        initialLoadComplete = true; // åˆå›èª­ã¿è¾¼ã¿/æ›´æ–°å®Œäº†

      }, (error) => {
        // ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
        console.error("Firebase Read Error:", error);
        showStatus(`ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        container.innerHTML = `<p style="text-align:center; color:red; margin-top: 20px;">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®š(${firebaseConfig.databaseURL})ã‚„ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>`;
        showLoading(false);
      });
    }


    // ä»˜ç®‹ã®DOMè¦ç´ ã‚’ä½œæˆã—ã¦ã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ ã™ã‚‹é–¢æ•°
    function createNoteElement(noteData, container) {
        if (!noteData || !noteData.id) {
            console.error("Invalid note data passed to createNoteElement:", noteData);
            return;
        }

      const noteDiv = document.createElement('div');
      noteDiv.className = 'note';
      noteDiv.dataset.id = noteData.id; // Firebaseã®ã‚­ãƒ¼ã‚’dataå±æ€§ã«ä¿æŒ
      noteDiv.style.left = (noteData.x || 10) + 'px';
      noteDiv.style.top = (noteData.y || 10) + 'px';
      noteDiv.style.backgroundColor = noteData.color || '#fffacd';
      noteDiv.style.zIndex = Object.keys(notesOnBoard).length + 1;

      // ä»˜ç®‹ã®å†…å®¹ã‚’è¡¨ç¤ºãƒ»ç·¨é›†ã™ã‚‹éƒ¨åˆ†
      const contentDiv = document.createElement('div');
      contentDiv.className = 'note-content';
      contentDiv.textContent = noteData.content;
      contentDiv.contentEditable = "true";

      // â–¼â–¼â–¼ ã“ã“ã‹ã‚‰ä¿®æ­£ â–¼â–¼â–¼
      contentDiv.addEventListener('blur', (e) => {
        const noteId = noteDiv.dataset.id; // è¦ªè¦ç´ ã‹ã‚‰ noteId ã‚’å–å¾—
        const newContent = e.target.textContent; // ç·¨é›†å¾Œã®ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹
        const currentNoteData = notesOnBoard[noteId]?.data;

        // å†…å®¹ãŒå®Ÿéš›ã«å¤‰æ›´ã•ã‚ŒãŸå ´åˆã®ã¿æ›´æ–°å‡¦ç†ã‚’è¡Œã†
        if (currentNoteData && currentNoteData.content !== newContent) {
          updateNoteOnServer(noteId, { content: newContent });
          // ã‚ªãƒ—ã‚·ãƒ§ãƒ³: ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚å³æ™‚æ›´æ–°ã™ã‚‹ï¼ˆFirebaseã‹ã‚‰ã®åŒæœŸã‚’å¾…ãŸãšã«UIã«åæ˜ ï¼‰
          // ãŸã ã—ã€Firebaseã® 'value' ã‚¤ãƒ™ãƒ³ãƒˆã§ã‚‚æ›´æ–°ã•ã‚Œã‚‹ã®ã§ã€äºŒé‡æ›´æ–°ã«ãªã‚‹å¯èƒ½æ€§ã«æ³¨æ„ã€‚
          // ã“ã®å ´åˆã¯ã€Firebaseã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ã‚’ä¿¡é ¼ã—ã¦ã€ã“ã®è¡Œã¯ãªãã¦ã‚‚è‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
          // notesOnBoard[noteId].data.content = newContent;
        }
      });

      contentDiv.addEventListener('keydown', (e) => {
        // ä¾‹ãˆã°ã€Shift+Enterã§æ”¹è¡Œã€Enterã ã‘ã§ä¿å­˜ã®ã‚ˆã†ãªåˆ¶å¾¡ã‚‚ã“ã“ã«è¿½åŠ å¯èƒ½
        // ä»Šå›ã¯blurã‚¤ãƒ™ãƒ³ãƒˆã§ä¿å­˜ã™ã‚‹ã®ã§ã€keydownã¯ç‰¹ã«ä½•ã‚‚ã—ãªãã¦ã‚‚è‰¯ã„
        // ã‚‚ã—Enterã‚­ãƒ¼ã§ã®é€ä¿¡ã‚’é˜²ããŸã„å ´åˆã¯ e.preventDefault() ãªã©ã‚’ä½¿ã†
        if (e.key === 'Enter' && !e.shiftKey) {
            // Enterã‚­ãƒ¼ã ã‘ã§é€ä¿¡ã™ã‚‹ã‚ˆã†ãªæŒ™å‹•ã«ã—ãŸã„å ´åˆã€ã“ã“ã§blurã‚’ç™ºç«ã•ã›ã‚‹ã‹ä¿å­˜å‡¦ç†ã‚’å‘¼ã¶
            // e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ”¹è¡Œã‚’é˜²ã
            // e.target.blur(); // blurã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã•ã›ã¦ä¿å­˜
        }
      });
      // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

      // â–¼â–¼â–¼ æ“ä½œãƒœã‚¿ãƒ³ï¼ˆè‰²å¤‰æ›´ã€å‰Šé™¤ï¼‰ã®ã‚³ãƒ³ãƒ†ãƒŠ (ã“ã“ã‹ã‚‰å¤‰æ›´) â–¼â–¼â–¼
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'note-actions'; // classåã¯ç¶­æŒ

      // å·¦å´: è‰²å¤‰æ›´ãƒœã‚¿ãƒ³ã¨ID
      const leftActions = document.createElement('div');
      leftActions.className = 'note-action-left';

      const colorButtonContainer = document.createElement('div'); // ãƒœã‚¿ãƒ³ã¨IDã‚’ã¾ã¨ã‚ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ
      colorButtonContainer.className = 'color-button-container'; // CSSã§ã‚¹ã‚¿ã‚¤ãƒ«æŒ‡å®šã™ã‚‹ãŸã‚ã‚¯ãƒ©ã‚¹è¿½åŠ 
      const colorButton = document.createElement('button');
      colorButton.className = 'icon-button color-button'; // æ–°ã—ã„ã‚¯ãƒ©ã‚¹å
      colorButton.title = 'è‰²ã‚’å¤‰æ›´';
      colorButton.onclick = (e) => {
          e.stopPropagation();
          openColorPicker(noteData.id, noteDiv);
      };
      colorButtonContainer.appendChild(colorButton);

      const noteIdSpan = document.createElement('span');
      noteIdSpan.className = 'note-id';
      noteIdSpan.textContent = noteData.id ? noteData.id.substring(0, 8) + '...' : ''; // IDã®å…ˆé ­8æ–‡å­—+...
      noteIdSpan.title = noteData.id || ''; // ãƒ›ãƒãƒ¼ã§å…¨æ–‡è¡¨ç¤º
      colorButtonContainer.appendChild(noteIdSpan);

      leftActions.appendChild(colorButtonContainer);

      // å³å´: å‰Šé™¤ãƒœã‚¿ãƒ³
      const rightActions = document.createElement('div');
      rightActions.className = 'note-action-right';

      const deleteButton = document.createElement('button');
      deleteButton.className = 'text-button delete-button';
      deleteButton.textContent = 'å‰Šé™¤';
      deleteButton.title = 'å‰Šé™¤';
      deleteButton.onclick = (e) => {
          e.stopPropagation();
          deleteNoteFromServer(noteData.id);
      };
      rightActions.appendChild(deleteButton);

      // å·¦å³ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ actionsDiv ã«è¿½åŠ 
      actionsDiv.appendChild(leftActions);
      actionsDiv.appendChild(rightActions);
      // â–²â–²â–² æ“ä½œãƒœã‚¿ãƒ³ã®å¤‰æ›´ã“ã“ã¾ã§ â–²â–²â–²

      // è¦ç´ ã‚’çµ„ã¿ç«‹ã¦ã‚‹
      noteDiv.appendChild(contentDiv);
      noteDiv.appendChild(actionsDiv);
      noteDiv.addEventListener('mousedown', onDragStart);

      // ä»˜ç®‹ã‚’ã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ 
      container.appendChild(noteDiv);
      notesOnBoard[noteData.id] = { element: noteDiv, data: noteData };
    }

    // â˜… æ–°ã—ã„ä»˜ç®‹ã‚’è¿½åŠ ã™ã‚‹é–¢æ•° (FABãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã³å‡ºã™)
    function addNote() {
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§æ–°ã—ã„ä»˜ç®‹ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
      const newNoteData = {
        content: "", // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å†…å®¹
        color: "#fffacd", // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è‰² (ãƒ¬ãƒ¢ãƒ³)
        // é…ç½®ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã®è¡¨ç¤ºé ˜åŸŸå†…ã«ãªã‚‹ã‚ˆã†ã«èª¿æ•´
        x: Math.floor(Math.random() * (document.getElementById('notes-container').clientWidth - 230)) + 10,
        y: Math.floor(Math.random() * (document.getElementById('notes-container').clientHeight / 2)) + 10, // ä¸ŠåŠåˆ†ã«é…ç½®
        createdAt: firebase.database.ServerValue.TIMESTAMP
      };

      showLoading(true);
      // Firebase Realtime Databaseã«ãƒ‡ãƒ¼ã‚¿ã‚’push
      notesRef.push(newNoteData)
        .then((newRef) => { // pushæˆåŠŸæ™‚ã«æ–°ã—ã„ä»˜ç®‹ã®å‚ç…§(IDå«ã‚€)ãŒå–å¾—ã§ãã‚‹
          showLoading(false);
          showStatus("æ–°ã—ã„ä»˜ç®‹ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚", 'success');
          // â˜… ã‚ªãƒ—ã‚·ãƒ§ãƒ³: æ–°ã—ãè¿½åŠ ã—ãŸä»˜ç®‹ã®å†…å®¹ã‚’ã™ãã«ç·¨é›†ã§ãã‚‹ã‚ˆã†ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
          setTimeout(() => {
              const newNoteElement = document.querySelector(`.note[data-id="${newRef.key}"] .note-content`);
              if(newNoteElement) {
                  newNoteElement.focus();
                  // ãƒ†ã‚­ã‚¹ãƒˆå…¨é¸æŠ (ã‚ˆã‚Šç·¨é›†ã—ã‚„ã™ã)
                  const range = document.createRange();
                  range.selectNodeContents(newNoteElement);
                  const sel = window.getSelection();
                  sel.removeAllRanges();
                  sel.addRange(range);
              }
          }, 200); // DOMæç”»ã¨FirebaseåŒæœŸã‚’å°‘ã—å¾…ã¤

        })
        .catch(err => {
          showLoading(false);
          showStatus(`è¿½åŠ ã‚¨ãƒ©ãƒ¼: ${err.message}`, 'error');
          console.error("Firebase Write Error (Add):", err);
        });
    }

    // ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã‚’é–‹ãé–¢æ•° (å¤‰æ›´ãªã—)
     function openColorPicker(noteId, noteDiv) {
        let existingPicker = document.querySelector('.color-palette');
        if (existingPicker) {
            existingPicker.remove();
            if (existingPicker.dataset.noteId === noteId) return;
        }
        const picker = document.createElement('div');
        picker.className = 'color-palette';
        picker.dataset.noteId = noteId;
        Object.entries(noteColors).forEach(([hex, name]) => {
            const colorChip = document.createElement('span');
            colorChip.className = 'color-option';
            colorChip.style.backgroundColor = hex;
            colorChip.title = name;
            const currentNote = notesOnBoard[noteId]?.data;
            if (currentNote && currentNote.color === hex) {
                colorChip.classList.add('selected');
            }
            colorChip.onclick = (e) => {
                e.stopPropagation();
                updateNoteOnServer(noteId, { color: hex });
                picker.remove();
                document.body.removeEventListener('click', closePickerOnClickOutside, true);
            };
            picker.appendChild(colorChip);
        });
        noteDiv.appendChild(picker);
        setTimeout(() => {
            document.body.addEventListener('click', closePickerOnClickOutside, true);
        }, 0);
    }

    // ãƒ”ãƒƒã‚«ãƒ¼ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«ãƒ”ãƒƒã‚«ãƒ¼ã‚’é–‰ã˜ã‚‹é–¢æ•° (å¤‰æ›´ãªã—)
    function closePickerOnClickOutside(e) {
        const picker = document.querySelector('.color-palette');
        if (picker && !picker.contains(e.target) && !e.target.closest('.note-actions button')) { // ã‚«ãƒ©ãƒ¼ãƒœã‚¿ãƒ³è‡ªä½“ã‚‚é™¤å¤–
           picker.remove();
           document.body.removeEventListener('click', closePickerOnClickOutside, true);
        }
    }

    // ä»˜ç®‹ã®æƒ…å ±ã‚’Firebaseä¸Šã§æ›´æ–°ã™ã‚‹é–¢æ•° (å¤‰æ›´ãªã—)
    function updateNoteOnServer(noteId, updates) {
      const updateData = {
        ...updates,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
      };
      notesRef.child(noteId).update(updateData)
        .catch(err => {
          showStatus(`æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${err.message}`, 'error');
          console.error("Firebase Update Error:", err);
        });
    }

    // ä»˜ç®‹ã‚’Firebaseã‹ã‚‰å‰Šé™¤ã™ã‚‹é–¢æ•° (å¤‰æ›´ãªã—)
    function deleteNoteFromServer(noteId) {
      if (!confirm("ã“ã®ä»˜ç®‹ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
        return;
      }
      showLoading(true);
      notesRef.child(noteId).remove()
        .then(() => {
          showLoading(false);
          showStatus("ä»˜ç®‹ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚", 'success');
        })
        .catch(err => {
          showLoading(false);
          showStatus(`å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${err.message}`, 'error');
          console.error("Firebase Remove Error:", err);
        });
    }

    // --- ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç† (å¤‰æ›´ãªã—) ---
    function onDragStart(e) {
      if (e.target.isContentEditable || e.target.tagName === 'BUTTON' || e.target.closest('.color-palette')) { return; }
      if (window.getSelection) { window.getSelection().removeAllRanges(); } else if (document.selection) { document.selection.empty(); }
      e.preventDefault();
      draggedNote = this;
      let maxZ = 0;
      document.querySelectorAll('.note').forEach(n => { const z = parseInt(n.style.zIndex || '1'); if (z > maxZ) maxZ = z; });
      draggedNote.style.zIndex = maxZ + 1;
      const rect = draggedNote.getBoundingClientRect();
      offsetX = e.clientX - rect.left;
      offsetY = e.clientY - rect.top;
      draggedNote.style.opacity = '0.8';
      draggedNote.style.transform = 'scale(1.05) rotate(3deg)';
      draggedNote.style.cursor = 'grabbing';
    }
    function onDrag(e) {
      if (!draggedNote) return;
      e.preventDefault();
      const container = document.getElementById('notes-container');
      const containerRect = container.getBoundingClientRect();
      let newX = e.clientX - containerRect.left - offsetX;
      let newY = e.clientY - containerRect.top - offsetY;
      const noteWidth = draggedNote.offsetWidth;
      const noteHeight = draggedNote.offsetHeight;
      newX = Math.max(0, Math.min(newX, container.scrollWidth - noteWidth)); // scrollWidthã‚’ä½¿ã†
      newY = Math.max(0, Math.min(newY, container.scrollHeight - noteHeight)); // scrollHeightã‚’ä½¿ã†
      draggedNote.style.left = newX + 'px';
      draggedNote.style.top = newY + 'px';
    }
    function onDragEnd(e) {
      if (!draggedNote) return;
      draggedNote.style.opacity = '1';
      draggedNote.style.transform = 'scale(1) rotate(0deg)';
      draggedNote.style.cursor = 'grab';
      const noteId = draggedNote.dataset.id;
      const newX = parseInt(draggedNote.style.left);
      const newY = parseInt(draggedNote.style.top);
      const currentNote = notesOnBoard[noteId]?.data;
      if (currentNote && (currentNote.x !== newX || currentNote.y !== newY)) {
        updateNoteOnServer(noteId, { x: newX, y: newY });
      }
      draggedNote = null;
    }

    // --- ã“ã“ã¾ã§JavaScript ---
  </script>
</body>
</html>
