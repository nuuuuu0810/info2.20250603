<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>メールソート体験 (選択ソートビジュアライザー)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* === 全体構造 === */
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden; /* ページ全体のスクロールバーを消す */
            font-family: 'Roboto', Arial, sans-serif;
        }
        body {
            background-color: #FFF; /* Slightly off-white for areas outside panes */
            display: flex;
            flex-direction: column;
        }
        .main-container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            padding: 5px;
            gap: 5px;
        }
        .left-pane {
            flex: 5;
            background-color: #fff; /* Gmail content background */
            border: 1px solid #e0e0e0; /* Gmail subtle border */
            border-radius: 8px; /* Gmail like rounded corners for panes */
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }
        .right-pane {
            flex: 5;
            padding: 8px;
            background-color: #ffffff;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        /* 左ペイン上部固定ヘッダー */
        .left-pane-fixed-header {
            padding: 8px 16px;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
            box-sizing: border-box;
            flex: 7;
            min-height: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        /* === 左ペイン: Gmail風ヘッダー === */
        .gmail-top-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        .gmail-search-bar-mock {
            flex-grow: 1;
            display: flex;
            align-items: center;
            background-color: #f1f3f4;
            border-radius: 24px;
            padding: 0 12px;
            height: 48px;
            box-sizing: border-box;
        }
        .gmail-search-bar-mock .menu-icon-mock {
            font-size: 20px;
            color: #5f6368;
            margin-right: 16px;
            padding: 8px;
            cursor: default;
            display: flex;
            align-items: center;
        }
        .gmail-search-bar-mock input {
            flex-grow: 1;
            border: none;
            outline: none;
            font-size: 16px;
            background-color: transparent;
            color: #3c4043;
            padding: 8px 0;
        }
        .gmail-search-bar-mock input::placeholder {
            color: #5f6368;
        }
        .gmail-search-bar-mock .search-button-mock {
            font-size: 20px;
            color: #5f6368;
            margin-left: 12px;
            padding: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .gmail-search-bar-mock .search-button-mock:hover {
            background-color: #e8eaed;
            border-radius: 50%;
        }


        .gmail-category-tabs-mock {
            display: flex;
            gap: 0;
            font-size: 14px;
            color: #5f6368;
            border-bottom: 1px solid #e0e0e0;
            margin-left: -16px;
            margin-right: -16px;
            margin-top: 8px;
            padding-left: 16px;
        }
        .gmail-category-tabs-mock span {
            cursor: default;
            padding: 12px 20px;
            border-bottom: 3px solid transparent;
            margin-bottom: -1px;
            position: relative;
        }
        .gmail-category-tabs-mock span.active {
            color: #d93025;
            border-bottom-color: #d93025;
            font-weight: 500;
        }
        .gmail-category-tabs-mock span:not(.active):hover {
            background-color: #f8f9fa;
        }


        /* === 左ペイン: ソートコントロールとメール一覧 === */
        .sort-controls-wrapper {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 8px 0 4px 0;
            box-sizing: border-box;
            margin-top: auto;
        }
        .sort-controls label { margin-right: 6px; font-weight: 500; font-size: 13px; color: #3c4043; }
        .sort-controls select {
            padding: 5px 8px;
            border-radius: 4px;
            border: 1px solid #dadce0;
            font-size: 13px;
            background-color: #fff;
            color: #3c4043;
        }
        .sort-controls select:hover {
            border-color: #c6c6c6;
        }
        .sort-controls select:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 1px #1a73e8;
        }


        #search-results {
            flex: 27;
            min-height: 0;
            overflow-y: auto;
            position: relative;
            box-sizing: border-box;
            padding: 6px 0;
        }
        .result-item {
            display: flex;
            align-items: center;
            padding: 0 16px;
            border-bottom: 1px solid #e8eaed;
            background-color: #fff;
            cursor: pointer;
            height: 45px;
            box-sizing: border-box;
            margin-bottom: 3px;
            transition: border-color 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease-in-out;
        }
        .result-item:last-child {
            margin-bottom: 0;
        }
        .result-item:hover {
            background-color: #f5f5f5;
            box-shadow: inset 1px 0 0 #dadce0, inset -1px 0 0 #dadce0, 0 1px 2px 0 rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15);
            z-index: 2;
        }

        .email-actions-start {
            display: flex;
            align-items: center;
            margin-right: 12px;
            flex-shrink: 0;
        }
        .email-checkbox {
            margin-right: 10px;
            width: 16px;
            height: 16px;
            accent-color: #1a73e8;
            cursor: pointer;
        }
        .email-icon {
            font-size: 18px;
            color: #5f6368;
            padding: 4px;
            border-radius: 50%;
            cursor: pointer;
        }
        .email-icon:hover {
            background-color: #e8eaed;
        }
        .star-icon { margin-right: 8px; }


        .email-main-content {
            display: flex;
            align-items: center;
            overflow: hidden;
            flex-grow: 1;
            gap: 12px;
        }
        .sender-name {
            font-size: 14px;
            color: #202124;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-basis: 150px;
            flex-shrink: 0;
        }
        .subject-snippet-wrapper {
            display: flex;
            align-items: baseline;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            flex-grow: 1;
        }
        .subject {
            font-size: 14px;
            color: #202124;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .email-snippet-separator {
            font-size: 14px;
            color: #5f6368;
            margin: 0 4px;
        }
        .snippet {
            font-size: 14px;
            color: #5f6368;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Read/Unread Styles */
        .result-item.unread .sender-name,
        .result-item.unread .subject {
            font-weight: 700;
            color: #202124;
        }
        .result-item.read .sender-name {
            font-weight: 400;
            color: #5f6368;
        }
         .result-item.read .subject {
            font-weight: 400;
            color: #5f6368;
        }


        .email-meta-end {
            display: flex;
            align-items: center;
            margin-left: auto;
            padding-left: 16px;
            flex-shrink: 0;
            position: relative;
        }
        .received-time {
            font-size: 12px;
            color: #5f6368;
            white-space: nowrap;
            font-weight: 500;
        }


        /* Visualizer Highlight Styles */
        .result-item.comparing { border-left: 4px solid #ffdd57; background-color: #fff9e0 !important; }
        .result-item.comparing2 { border-left: 4px solid #add8e6; background-color: #e0f2f7 !important; }
        .result-item.minimum { border: 2px solid #ff6b6b !important; background-color: #ffe0e0 !important; }
        .result-item.sorted {
            border-left: 4px solid #4caf50;
            background-color: #e8f5e9 !important;
        }
        .result-item.swapping {
            box-shadow: 0 0 8px 2px #f06292, inset 1px 0 0 #dadce0, inset -1px 0 0 #dadce0 !important;
        }


        /* === 右ペイン: ビジュアライザー === */
        #visualizer-container {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
            flex-grow: 1;
        }
        #visualizer-container.active { display: flex; }

        #visualizer-controls-header {
            display: flex;
            flex-direction: column;
            width: 100%;
            padding: 8px 10px;
            background-color: #ffffff;
            box-sizing: border-box;
            flex: 7;
            min-height: 0;
            justify-content: space-evenly;
        }
        .controls-row { width: 100%; box-sizing: border-box; }
        .top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .bottom-row { display: flex; justify-content: center; align-items: center; }

        .header-left-controls button,
        .header-right-controls label,
        .header-right-controls input[type="range"],
        .header-right-controls span {
            padding: 6px 9px;
            border-radius: 4px;
            font-size: 13px;
            margin: 0 3px;
        }
        .header-left-controls button {
            background-color: #1a73e8;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
        }
        .header-left-controls button:hover { background-color: #1765cc; }
        .header-left-controls button:disabled { background-color: #dadce0; color: #80868b; cursor: not-allowed; }

        #status-text-area {
            text-align: center;
            font-size: 14px;
            color: #3c4043;
            padding: 4px 0;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            height: 2.5em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .header-right-controls { display: flex; align-items: center; }
        #speed-control-container { display: flex; align-items: center; gap: 4px; }
        #speed-control-container label { margin-right: 2px; font-weight: 500; color: #3c4043;}
        #speed-slider { accent-color: #1a73e8; }


        #bar-chart-area {
            display: flex;
            flex-direction: column;
            width: 100%;
            flex: 27;
            min-height: 0;
            overflow-y: auto;
            padding: 6px;
            box-sizing: border-box;
            border-radius: 3px;
            position: relative;
        }
        .bar-container {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
            height: 45px;
            box-sizing: border-box;
            padding: 2px 0;
            transition: transform 0.3s ease-in-out;
        }
        .bar-container:last-child {
            margin-bottom: 0;
        }
        .bar-label {
            min-width: 55px;
            font-size: 11px;
            color: #3c4043;
            text-align: right;
            margin-right: 4px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .bar {
            height: 30px;
            flex-grow: 1;
            background-color: #dadce0;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            display: flex;
            justify-content: center; 
            align-items: center;
            padding: 0 8px;
            box-sizing: border-box;
            border-radius: 3px;
            font-size: 12px;
            overflow: hidden;
            cursor: default;
            color: #202124;
            white-space: nowrap;
            text-overflow: ellipsis;
            border: 1px solid transparent;
        }

        .bar.comparing { background-color: #ffdd57; color: #333; border-color: #fbc02d; }
        .bar.comparing2 { background-color: #add8e6; color: #333; border-color: #81c7d4; }
        .bar.minimum { border: 2px solid #d93025 !important; background-color: #fce8e6; color: #a50e0e;}
        .bar.sorted {
            background-color: #e6f4ea;
            border-color: #81c995;
            color: #137333;
        }
        .bar-container.swapping .bar {
        }

        #right-pane-placeholder {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: #5f6368;
            height: 100%;
            font-size: 14px;
        }
        #right-pane-placeholder.hidden { display: none; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="left-pane">
            <div class="left-pane-fixed-header">
                <div class="gmail-top-header">
                    <div class="gmail-search-bar-mock">
                        <span class="menu-icon-mock">☰</span>
                        <input type="text" value="" placeholder="メールを検索" aria-label="メールを検索">
                       <span class="search-button-mock" role="button" aria-label="検索">
    <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 0 24 24" width="20px" fill="currentColor">
        <path d="M0 0h24v24H0V0z" fill="none"/>
        <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
    </svg>
</span>
                    </div>
                </div>
                 <div class="gmail-category-tabs-mock">
                    <span class="active">メイン</span>
                    <span>プロモーション</span>
                    <span>ソーシャル</span>
                    <span>新着</span>
                    <span>フォーラム</span>
                </div>
                <div class="sort-controls-wrapper">
                    <div class="sort-controls">
                        <label for="sort-by">並び替え:</label>
                        <select id="sort-by">
                            <option value="receivedDate_default_desc">新しい順</option>
                            <option value="receivedDate_default_asc">古い順</option>
                            <option value="senderName_default_asc">送信者名 (昇順)</option>
                            <option value="senderName_default_desc">送信者名 (降順)</option>
                        </select>
                    </div>
                </div>
            </div>
            <div id="search-results">
                <!-- メール一覧はここにJSで生成 -->
            </div>
        </div>

        <div class="right-pane">
            <div id="right-pane-placeholder">
                <p>左のドロップダウンから並び替え方法を選択すると、<br>メール一覧が選択ソートで並び替えられる様子がここに表示されます。</p>
            </div>
            <div id="visualizer-container">
                <div id="visualizer-controls-header">
                    <div class="controls-row top-row">
                        <div class="header-left-controls">
                            <button id="start-pause-button">開始</button>
                            <button id="reset-button">リセット</button>
                        </div>
                        <div class="header-right-controls">
                            <div id="speed-control-container">
                                <label for="speed-slider">速度:</label>
                                <input type="range" id="speed-slider" min="0.1" max="2" step="0.1" value="1">
                                <span id="speed-value">x1.0</span>
                            </div>
                        </div>
                    </div>
                    <div class="controls-row bottom-row">
                        <div id="status-text-area">
                            <!-- ステータスはここにJSで表示 -->
                        </div>
                    </div>
                    <div id="sort-key-selector-container" style="display:none;">
                         <select id="sort-key-selector">
                            <option value="id_asc">ID (昇順)</option>
                            <option value="id_desc">ID (降順)</option>
                            <option value="senderName_asc">送信者名 (昇順)</option>
                            <option value="senderName_desc">送信者名 (降順)</option>
                            <option value="receivedDate_asc">受信日時 (古い順)</option>
                            <option value="receivedDate_desc">受信日時 (新しい順)</option>
                        </select>
                    </div>
                </div>
                <div id="bar-chart-area">
                    <!-- 棒グラフはここにJSで生成 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const initialSearchData = [
            { id: 1, senderName: "Alice Wonderland", senderEmail: "alice@example.com", subject: "会議の議題について", snippet: "明日の会議ですが、いくつか追加したい議題があります...", receivedDate: "2025-06-03T10:30:00", isUnread: true },
            { id: 2, senderName: "Bob The Builder", senderEmail: "bob@example.com", subject: "プロジェクト進捗報告", snippet: "現在のプロジェクトの進捗状況を報告します。詳細は添付ファイルをご確認ください。", receivedDate: "2025-06-02T09:15:00", isUnread: false },
            { id: 3, senderName: "Carol Danvers", senderEmail: "carol@example.com", subject: "Re: 週末の予定は如何でしょうか？ご確認願います。", snippet: "週末の件、了解しました！楽しみにしています。場所と時間ですが…", receivedDate: "2025-06-01T17:45:00", isUnread: true },
            { id: 4, senderName: "David Copperfield", senderEmail: "david@example.com", subject: "新しい提案資料の送付", snippet: "先日お話しした件について、新しい提案書を添付いたしましたのでご確認ください。", receivedDate: "2025-06-02T11:00:00", isUnread: false },
            { id: 5, senderName: "Eve Polastri", senderEmail: "eve@example.com", subject: "ランチのお誘い", snippet: "来週あたり都合の良い日でランチでもいかがですか？お店は...", receivedDate: "2025-06-02T14:20:00", isUnread: false },
            { id: 6, senderName: "Frankenstein", senderEmail: "frank@example.com", subject: "ご確認のお願い：例の件です", snippet: "先日お渡しした資料について、ご確認いただけましたでしょうか。ご多忙中恐縮ですが…", receivedDate: "2025-06-03T16:05:00", isUnread: true },
            { id: 7, senderName: "Grace Hopper", senderEmail: "grace@example.com", subject: "バグ報告 - ログイン画面", snippet: "システムに軽微なバグを発見しましたので報告します。再現手順は以下の通りです。", receivedDate: "2025-06-01T08:50:00", isUnread: false },
            { id: 8, senderName: "Henry Jekyll", senderEmail: "henry@example.com", subject: "Fwd: 重要なお知らせ - 全社通達", snippet: "関連情報として転送いたします。皆様ご確認ください。", receivedDate: "2025-06-02T09:00:00", isUnread: false },
            { id: 9, senderName: "Alice Wonderland", senderEmail: "alice@example.com", subject: "Re: Re: 会議の議題について", snippet: "承知いたしました。その内容で問題ございません。進めましょう。", receivedDate: "2025-06-02T14:00:00", isUnread: false },
            { id: 10, senderName: "Bob The Builder", senderEmail: "bob@example.com", subject: "休暇申請（来月分）", snippet: "お疲れ様です。来月の休暇申請を提出いたしますので、承認のほどよろしくお願いいたします。", receivedDate: "2025-06-01T11:30:00", isUnread: true },
            { id: 11, senderName: "Isaac Newton", senderEmail: "isaac@example.com", subject: "新しい物理法則の発見について", snippet: "万有引力の法則に続く、新たな発見の予感がしています。近いうちにご報告を…", receivedDate: "2025-06-03T18:00:00", isUnread: true },
            { id: 12, senderName: "Jane Austen", senderEmail: "jane@example.com", subject: "次回作の構想", snippet: "プライドと偏見に続く作品として、エマの執筆を進めています。ご期待ください。", receivedDate: "2025-06-02T14:30:00", isUnread: false },
            { id: 13, senderName: "Kevin McCallister", senderEmail: "kevin@example.com", subject: "クリスマスパーティーへの招待状", snippet: "今年のクリスマスは我が家で盛大なパーティーを開きます！ぜひご参加ください。", receivedDate: "2025-06-01T09:55:00", isUnread: true },
        ];

        const resultsContainerForLeftPane = document.getElementById('search-results');
        const sortBySelectForLeftPane = document.getElementById('sort-by');
        const rightPanePlaceholder = document.getElementById('right-pane-placeholder');
        const visualizerContainer = document.getElementById('visualizer-container');

        function formatDate(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);

            const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: false };
            const timeStr = date.toLocaleTimeString('ja-JP', timeOptions);

            if (date.toDateString() === today.toDateString()) {
                return timeStr;
            }
            if (date.toDateString() === yesterday.toDateString()) {
                return `昨日 ${timeStr}`;
            }
            const dateOptionsBase = { month: 'short', day: 'numeric' };
            if (date.getFullYear() === today.getFullYear()) {
                 return `${date.toLocaleDateString('ja-JP', dateOptionsBase)} ${timeStr}`;
            }
            const dateOptionsWithYear = { year: 'numeric', ...dateOptionsBase };
            return `${date.toLocaleDateString('ja-JP', dateOptionsWithYear)} ${timeStr}`;
        }

        function formatDateForBar(dateString) {
            const date = new Date(dateString);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${month}/${day} ${hours}:${minutes}`;
        }


        // --- 右ペイン: ビジュアライザーと左ペイン同期のJavaScript ---
        (function() {
            'use strict';
            const barChartArea = document.getElementById('bar-chart-area');
            const startPauseButton = document.getElementById('start-pause-button');
            const resetButton = document.getElementById('reset-button');
            const speedSlider = document.getElementById('speed-slider');
            const speedValueDisplay = document.getElementById('speed-value');
            const statusTextArea = document.getElementById('status-text-area');

            let currentDataToSort = [];
            let barElementsMap = new Map();
            let leftItemElementsMap = new Map();

            let animationSpeedFactor = 1;
            let currentTimeoutId = null;
            let isSorting = false;
            let isPaused = false;
            let sortGenerator = null;

            let currentSortKeyFromUI = 'receivedDate_desc';
            const BASE_DELAY = 500;

            function convertHighlightIndicesToItemIds(highlightIndices, dataArray) {
                const idHighlights = { sortedItemIds: [], swappingItemIds: [] };
                if (highlightIndices.comparing1 !== undefined && dataArray[highlightIndices.comparing1]) {
                    idHighlights.comparing1ItemId = dataArray[highlightIndices.comparing1].id;
                }
                if (highlightIndices.comparing2 !== undefined && dataArray[highlightIndices.comparing2]) {
                    idHighlights.comparing2ItemId = dataArray[highlightIndices.comparing2].id;
                }
                if (highlightIndices.minimum !== undefined && dataArray[highlightIndices.minimum]) {
                    idHighlights.minimumItemId = dataArray[highlightIndices.minimum].id;
                }
                if (highlightIndices.sortedBoundary !== undefined) {
                    for (let i = 0; i <= highlightIndices.sortedBoundary; i++) {
                        if (dataArray[i]) idHighlights.sortedItemIds.push(dataArray[i].id);
                    }
                }
                 if (highlightIndices.swapping) {
                    highlightIndices.swapping.forEach(idx => {
                        if (dataArray[idx]) idHighlights.swappingItemIds.push(dataArray[idx].id);
                    });
                }
                return idHighlights;
            }

            function renderResultsForLeftPane(items, highlightItemIds = {}) {
                resultsContainerForLeftPane.innerHTML = '';
                leftItemElementsMap.clear();

                items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'result-item';
                    itemDiv.classList.add(item.isUnread ? 'unread' : 'read');
                    itemDiv.dataset.id = item.id;
                    itemDiv.innerHTML = `
                        <div class="email-actions-start">
                            <input type="checkbox" class="email-checkbox" aria-label="メール ${item.id} を選択">
                            <span class="email-icon star-icon" aria-label="スターを付ける">☆</span>
                        </div>
                        <div class="email-main-content">
                            <span class="sender-name" title="${item.senderName} <${item.senderEmail}>">${item.senderName}</span>
                            <div class="subject-snippet-wrapper">
                                <span class="subject" title="${item.subject}">${item.subject}</span>
                                <span class="email-snippet-separator"> - </span>
                                <span class="snippet" title="${item.snippet}">${item.snippet}</span>
                            </div>
                        </div>
                        <div class="email-meta-end">
                            <span class="received-time">${formatDate(item.receivedDate)}</span>
                        </div>
                    `;

                    if (highlightItemIds.comparing1ItemId === item.id) itemDiv.classList.add('comparing');
                    if (highlightItemIds.comparing2ItemId === item.id) itemDiv.classList.add('comparing2');
                    if (highlightItemIds.minimumItemId === item.id) itemDiv.classList.add('minimum');
                    if (highlightItemIds.sortedItemIds && highlightItemIds.sortedItemIds.includes(item.id)) itemDiv.classList.add('sorted');
                    if (highlightItemIds.swappingItemIds && highlightItemIds.swappingItemIds.includes(item.id)) itemDiv.classList.add('swapping');

                    resultsContainerForLeftPane.appendChild(itemDiv);
                    leftItemElementsMap.set(item.id, itemDiv);
                });
            }

            function getBarDisplayValue(item, keyBase) {
                const value = item[keyBase];
                if (keyBase === 'senderName') {
                    const maxLength = 10;
                    return typeof value === 'string' && value.length > maxLength ? value.substring(0, maxLength - 1) + "…" : value;
                }
                if (keyBase === 'receivedDate') return formatDateForBar(value);
                return `ID:${item.id}`;
            }

            function propertyToSortKeyLabel(selectedKeyWithValue) {
                const parts = selectedKeyWithValue.split('_');
                const keyBase = parts[0]; const order = parts[1];
                let label = "";
                if (keyBase === 'senderName') label += "送信者名";
                else if (keyBase === 'receivedDate') label += "受信日時";
                else label += "ID";

                if (order === 'asc') label += " (昇順)";
                else if (order === 'desc') label += " (降順)";
                return label;
            }

            function drawBothPanes(highlightIndices = {}) {
                barChartArea.innerHTML = '';
                barElementsMap.clear();
                const sortKeyBase = currentSortKeyFromUI.split('_')[0];

                currentDataToSort.forEach((item, index) => {
                    const barContainer = document.createElement('div');
                    barContainer.className = 'bar-container';
                    barContainer.dataset.id = item.id;

                    const labelSpan = document.createElement('div');
                    labelSpan.className = 'bar-label';
                    let displayName = item.senderName.split(' ')[0] || item.senderName;
                    const maxLabelLength = 7;

                    if (displayName.length > maxLabelLength) {
                        displayName = displayName.substring(0, maxLabelLength) + "…";
                    }
                    labelSpan.textContent = displayName;
                    labelSpan.title = item.senderName;

                    const bar = document.createElement('div');
                    bar.className = 'bar';
                    const displayVal = getBarDisplayValue(item, sortKeyBase);
                    bar.textContent = displayVal;

                    if (sortKeyBase === 'senderName' && item.senderName !== displayVal) bar.title = item.senderName;
                    else if (sortKeyBase === 'receivedDate') bar.title = new Date(item.receivedDate).toLocaleString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                    else bar.title = `ID ${item.id}: ${displayVal}`;


                    if (highlightIndices.comparing1 === index) bar.classList.add('comparing');
                    if (highlightIndices.comparing2 === index) bar.classList.add('comparing2');
                    if (highlightIndices.minimum === index) bar.classList.add('minimum');

                    if (highlightIndices.sortedBoundary !== undefined && index <= highlightIndices.sortedBoundary) {
                        bar.classList.add('sorted');
                    }

                    if (highlightIndices.swapping && highlightIndices.swapping.includes(index)) {
                        barContainer.classList.add('swapping');
                        barContainer.style.boxShadow = '0 0 8px 1px #f06292';
                    } else {
                        barContainer.style.boxShadow = '';
                    }

                    barContainer.appendChild(labelSpan);
                    barContainer.appendChild(bar);
                    barChartArea.appendChild(barContainer);
                    barElementsMap.set(item.id, barContainer);
                });

                const highlightItemIds = convertHighlightIndicesToItemIds(highlightIndices, currentDataToSort);
                renderResultsForLeftPane(currentDataToSort, highlightItemIds);
            }

            async function animateSwap(idx1, idx2) {
                const item1Id = currentDataToSort[idx1].id;
                const item2Id = currentDataToSort[idx2].id;

                const barEl1 = barElementsMap.get(item1Id);
                const barEl2 = barElementsMap.get(item2Id);
                const leftItemEl1 = leftItemElementsMap.get(item1Id);
                const leftItemEl2 = leftItemElementsMap.get(item2Id);

                if (!barEl1 || !barEl2 || !leftItemEl1 || !leftItemEl2) return;

                const swapDuration = (BASE_DELAY / animationSpeedFactor) * 0.35;

                const barRect1 = barEl1.getBoundingClientRect();
                const barRect2 = barEl2.getBoundingClientRect();
                const yDiffBar = barRect1.top - barRect2.top;

                barEl1.style.transition = `transform ${swapDuration}ms ease-in-out`;
                barEl2.style.transition = `transform ${swapDuration}ms ease-in-out`;
                barEl1.style.zIndex = '10'; barEl2.style.zIndex = '10';
                barEl1.style.transform = `translateY(${-yDiffBar}px)`;
                barEl2.style.transform = `translateY(${yDiffBar}px)`;

                const leftRect1 = leftItemEl1.getBoundingClientRect();
                const leftRect2 = leftItemEl2.getBoundingClientRect();
                const yDiffLeft = leftRect1.top - leftRect2.top;

                leftItemEl1.style.transition = `transform ${swapDuration}ms ease-in-out`;
                leftItemEl2.style.transition = `transform ${swapDuration}ms ease-in-out`;
                leftItemEl1.style.zIndex = '1000'; leftItemEl2.style.zIndex = '1000';
                leftItemEl1.style.transform = `translateY(${-yDiffLeft}px)`;
                leftItemEl2.style.transform = `translateY(${yDiffLeft}px)`;

                await new Promise(resolve => setTimeout(resolve, swapDuration + 50));

                barEl1.style.transform = ''; barEl2.style.transform = '';
                barEl1.style.zIndex = ''; barEl2.style.zIndex = '';
                barEl1.style.transition = ''; barEl2.style.transition = '';

                leftItemEl1.style.transform = ''; leftItemEl2.style.transform = '';
                leftItemEl1.style.zIndex = ''; leftItemEl2.style.zIndex = '';
                const originalTransition = 'border-color 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease-in-out';
                leftItemEl1.style.transition = originalTransition;
                leftItemEl2.style.transition = originalTransition;
            }

            function updateStatus(htmlText) { statusTextArea.innerHTML = htmlText; }
            async function delay() { return new Promise(resolve => { currentTimeoutId = setTimeout(resolve, BASE_DELAY / animationSpeedFactor); }); }

            function compareItems(itemA, itemB, keyBase, order) {
                let valA = itemA[keyBase]; let valB = itemB[keyBase];

                if (keyBase === 'receivedDate') {
                    valA = new Date(valA).getTime();
                    valB = new Date(valB).getTime();
                }

                if (typeof valA === 'string' && typeof valB === 'string' && keyBase === 'senderName') {
                    return order === 'asc' ? valA.localeCompare(valB, 'ja') : valB.localeCompare(valA, 'ja');
                }
                return order === 'asc' ? valA - valB : valB - valA;
            }

            async function* selectionSortGenerator() {
                let arr = [...currentDataToSort];
                let n = arr.length;
                const [fixedSortKeyBase, fixedSortOrder] = currentSortKeyFromUI.split('_');

                for (let i = 0; i < n - 1; i++) {
                    let extremumIdx = i;
                    currentDataToSort = [...arr];
                    drawBothPanes({ comparing1: i, sortedBoundary: i - 1 });
                    updateStatus(`パス ${i + 1}: 候補 <b>${getBarDisplayValue(arr[i], fixedSortKeyBase)}</b> を${fixedSortOrder === 'asc' ? '最小' : '最大'}値とする`);
                    await delay(); if (isPaused) yield 'paused'; if (!isSorting) return;

                    for (let j = i + 1; j < n; j++) {
                        drawBothPanes({ comparing1: extremumIdx, comparing2: j, sortedBoundary: i - 1 });
                        updateStatus(`比較: 候補 <b>${getBarDisplayValue(arr[extremumIdx], fixedSortKeyBase)}</b> と 対象 <b>${getBarDisplayValue(arr[j], fixedSortKeyBase)}</b>`);
                        await delay(); if (isPaused) yield 'paused'; if (!isSorting) return;

                        const comparisonResult = compareItems(arr[j], arr[extremumIdx], fixedSortKeyBase, fixedSortOrder);
                        if (comparisonResult < 0) {
                            extremumIdx = j;
                            drawBothPanes({ minimum: extremumIdx, comparing2: j, sortedBoundary: i - 1 });
                            updateStatus(`新${fixedSortOrder === 'asc' ? '最小' : '最大'}値候補: <b>${getBarDisplayValue(arr[extremumIdx], fixedSortKeyBase)}</b>`);
                            await delay(); if (isPaused) yield 'paused'; if (!isSorting) return;
                        }
                    }

                    if (extremumIdx !== i) {
                        updateStatus(`交換: <b>${getBarDisplayValue(arr[i], fixedSortKeyBase)}</b> と <b>${getBarDisplayValue(arr[extremumIdx], fixedSortKeyBase)}</b>`);
                        currentDataToSort = [...arr];
                        drawBothPanes({ swapping: [i, extremumIdx], sortedBoundary: i - 1 });
                        await animateSwap(i, extremumIdx);
                        if (isPaused) yield 'paused'; if (!isSorting) return;

                        [arr[i], arr[extremumIdx]] = [arr[extremumIdx], arr[i]];
                        currentDataToSort = [...arr];
                        drawBothPanes({ sortedBoundary: i });
                        updateStatus(`交換完了。位置 ${i} 確定: <b>${getBarDisplayValue(arr[i], fixedSortKeyBase)}</b>`);
                    } else {
                        updateStatus(`位置 ${i} (<b>${getBarDisplayValue(arr[i], fixedSortKeyBase)}</b>) は既に正しい。`);
                        currentDataToSort = [...arr];
                        drawBothPanes({ sortedBoundary: i });
                    }
                    await delay(); if (isPaused) yield 'paused'; if (!isSorting) return;
                }
                currentDataToSort = [...arr];
                drawBothPanes({ sortedBoundary: currentDataToSort.length - 1 });
                updateStatus("ソート完了！");
                return arr;
            }


            async function runSortStep() {
                if (!isSorting || isPaused) return;
                try {
                    const result = await sortGenerator.next();
                    if (result.value === 'paused') return;
                    if (result.done) {
                        isSorting = false;
                        startPauseButton.textContent = "開始";
                        startPauseButton.disabled = true;
                        resetButton.disabled = false;
                    } else if (isSorting && !isPaused) {
                        runSortStep();
                    }
                } catch (error) {
                    console.error("Sort step error:", error);
                    updateStatus("エラーが発生しました。<br>リセットしてください。");
                    window.stopSortVisualizer();
                }
            }

            function startSort() {
                if (isSorting && !isPaused) return;
                isSorting = true; isPaused = false;
                startPauseButton.textContent = "一時停止";
                resetButton.disabled = true;

                if (!sortGenerator) {
                    sortGenerator = selectionSortGenerator();
                }
                runSortStep();
            }

            function pauseSort() {
                if (!isSorting || isPaused) return;
                isPaused = true;
                clearTimeout(currentTimeoutId);
                startPauseButton.textContent = "再開";
                resetButton.disabled = false;
                updateStatus("一時停止中...");
            }

            function resumeSort() {
                if (!isSorting || !isPaused) return;
                isPaused = false;
                startPauseButton.textContent = "一時停止";
                resetButton.disabled = true;
                updateStatus("再開します...");
                runSortStep();
            }

            window.stopSortVisualizer = function() {
                isSorting = false; isPaused = true;
                clearTimeout(currentTimeoutId);
                sortGenerator = null;
                startPauseButton.textContent = "開始";
                startPauseButton.disabled = false;
                resetButton.disabled = false;
            }

            window.initSortVisualizer = function(sortKeyBase, sortOrder) {
                window.stopSortVisualizer();
                currentDataToSort = JSON.parse(JSON.stringify(initialSearchData))
                                      .sort(() => 0.5 - Math.random());

                currentSortKeyFromUI = `${sortKeyBase}_${sortOrder}`;

                drawBothPanes();
                const sortLabel = propertyToSortKeyLabel(currentSortKeyFromUI);
                updateStatus(`選択ソート: 「${sortLabel}」<br>「開始」ボタンでソートを開始します。`);
                startPauseButton.disabled = false;
                isSorting = false; isPaused = false;

                rightPanePlaceholder.classList.add('hidden');
                visualizerContainer.classList.add('active');
            };

            startPauseButton.addEventListener('click', () => {
                if (!visualizerContainer.classList.contains('active')) {
                     updateStatus("まず左のドロップダウンで<br>並び替え方法を選択してください。");
                     return;
                }
                if (!isSorting) startSort();
                else if (isPaused) resumeSort();
                else pauseSort();
            });

            resetButton.addEventListener('click', () => {
                window.handleSortSelection();
            });

            speedSlider.addEventListener('input', (e) => {
                animationSpeedFactor = parseFloat(e.target.value);
                speedValueDisplay.textContent = `x${animationSpeedFactor.toFixed(1)}`;
            });

            window.handleSortSelection = function() {
                const sortByValue = sortBySelectForLeftPane.value;
                const [property, type, order] = sortByValue.split('_');

                let sortedDataForInitialLeftDisplay = [...initialSearchData];

                if (type === 'default') {
                    let displayCopy = JSON.parse(JSON.stringify(initialSearchData));
                    displayCopy.sort((a, b) => {
                        return compareItems(a, b, property, order);
                    });
                    sortedDataForInitialLeftDisplay = displayCopy;
                }

                if (!visualizerContainer.classList.contains('active') || !(type === 'default' && (property === 'receivedDate' || property === 'senderName'))) {
                     renderResultsForLeftPane(sortedDataForInitialLeftDisplay);
                }


                if (type === 'default' && (property === 'receivedDate' || property === 'senderName')) {
                    window.initSortVisualizer(property, order);
                } else {
                    rightPanePlaceholder.classList.remove('hidden');
                    visualizerContainer.classList.remove('active');
                    window.stopSortVisualizer();
                    renderResultsForLeftPane(sortedDataForInitialLeftDisplay);
                }
            }

        })();

        document.addEventListener('DOMContentLoaded', () => {
            sortBySelectForLeftPane.addEventListener('change', () => {
                window.handleSortSelection();
            });
            window.handleSortSelection(); // 初期表示のため呼び出し
        });
    </script>
</body>
</html>